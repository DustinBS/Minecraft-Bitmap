<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carpet Pattern Generator</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <main class="layout">
      <aside class="controls">
        <h1>Carpet Pattern Visualizer</h1>
        <form id="settingsForm" method="post">
          <section class="palette-list top">
            <h3>Available colors (Click to Add)</h3>
            <div class="palette-grid">
              {% for c in palette %}
                {% set rgb = palette_map.get(c) %}
                <button type="button" class="add-color" data-color="{{c}}" title="Add {{c}}">
                  <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                  {{c}}
                </button>
              {% endfor %}
            </div>
          </section>

          <section class="slots">
            <h2>Hotbar Slots</h2>
            <div class="slot-controls">
              <label title="Automatically sets the weight based on how many slots have the same color">
                <input id="autoWeights" type="checkbox" checked> Auto-calculate weights
              </label>
              <button type="button" id="clearAll" class="small" title="Reset all slots to empty">Clear all</button>
            </div>
            <div class="slots-scroll">
              {% for i in range(1, slots+1) %}
                <div class="slot-row" data-slot="{{i}}">
                  <select name="color_{{i}}" class="slot-select">
                    <option value="">--</option>
                    {% for c in palette %}
                      {% set selected = '' %}
                      {% if slot_choices|length >= i and slot_choices[i-1][0] == c %}
                        {% set selected = 'selected' %}
                      {% endif %}
                      <option value="{{c}}" {{selected}}>{{c}}</option>
                    {% endfor %}
                  </select>
                  <input class="weight" type="number" name="weight_{{i}}" min="0" max="1000" step="1" value="{{ slot_choices[i-1][1]|int if slot_choices|length >= i else 0 }}">
                  <button type="button" class="remove small">Remove</button>
                </div>
              {% endfor %}
            </div>
          </section>

          <div class="randomize-controls">
            <div class="randomize-header">
              <button type="button" id="randHotbar" class="small" title="Randomize hotbar (R)">Randomize (R)</button>
              <button type="button" id="randSubset" class="small" title="Randomize subset (S)">Randomize Subset (S)</button>
              <span class="hotkey-hint">Hotkeys: R/S</span>
            </div>
            <div class="subset-label-text">Pick subset for Randomize Subset (S):</div>
            <div class="subset-grid">
              {% for c in palette %}
                {% set rgb = palette_map.get(c) %}
                <button type="button" class="subset-color {% if subset_selected and c in subset_selected %}selected{% endif %}" data-color="{{c}}" title="Toggle {{c}}">
                  <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                </button>
              {% endfor %}
            </div>
            <input type="hidden" name="subset" id="subsetInput" value="{{ subset_selected|join(',') if subset_selected else '' }}">
          </div>

          <div class="grid-settings bottom">
            <h3 class="dimensions-heading">Dimensions</h3>
            <label>Width (blocks): <input name="width" value="{{width}}"></label>
            <label>Height (blocks): <input name="height" value="{{height}}"></label>
            <label>Pixels per block: <input name="block_px" value="{{block_px}}"></label>
          </div>
        </form>
      </aside>

      <section class="preview-area">
        <div class="output-header">
          <div class="legend">
            <h3 class="legend-heading">
              Unique Colors Used 
              <span class="help-icon" title="The number in parentheses represents the total weight assigned to that color across all input slots.">(?)</span>
            </h3>
            <ul id="legendList">
              {% for name, w in legend_choices %}
                {% set rgb = palette_map.get(name) %}
                {% if rgb %}
                  <li title="Total Weight: {{w}}">
                    <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                    {{name}}
                    <span class="legend-weight">({{w|int}})</span>
                  </li>
                {% else %}
                  <li title="Total Weight: {{w}}">{{name}} ({{w|int}})</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <h2 class="preview-title">Pattern Preview</h2>
          <div class="preview-actions">
            <button type="button" id="generateBtn" class="generate-primary" title="Generate new pattern (G)">Generate Preview (G)</button>
          </div>
        </div>

        <div class="preview" id="previewContainer">
          <img id="previewImg" src="data:image/png;base64,{{img_b64}}" alt="preview">
        </div>

        <div class="shortcuts-bar">
          <span><kbd>G</kbd> Generate</span>
          <span><kbd>R</kbd> Randomize</span>
          <span><kbd>S</kbd> Subset</span>
        </div>

        <div class="history-container">
          <div class="history-header">
            <h3 class="history-title">History</h3>
            <span class="history-empty" id="historyEmpty">No previous patterns</span>
          </div>
          <div class="history-gallery" id="historyGallery">
            <!-- Thumbnails injected here -->
          </div>
        </div>
      </section>
    </main>
    <script src="/static/script.js"></script>
  </body>
</html>
