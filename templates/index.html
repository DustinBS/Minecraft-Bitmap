<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carpet Pattern Generator</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <main class="layout">
      <aside class="controls">
        <h1>Carpet Pattern Visualizer</h1>
        <form id="settingsForm" method="post">
          <section class="palette-list top">
            <h3>Available colors</h3>
            <div class="palette-grid">
              {% for c in palette %}
                {% set rgb = palette_map.get(c) %}
                <button type="button" class="add-color" data-color="{{c}}" title="Add {{c}}">
                  <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                  {{c}}
                </button>
              {% endfor %}
            </div>
          </section>

          <section class="slots">
              <h2>Hotbar Slots</h2>
              <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <label style="margin-right:6px" title="Automatically sets the weight based on how many slots have the same color">
                  <input id="autoWeights" type="checkbox" checked> Auto-calculate weights
                </label>
                <!-- Sync button removed as it was redundant/confusing -->
                <button type="button" id="clearAll" class="small" title="Reset all slots to empty">Clear all</button>
              </div>
              <div class="slots-scroll">
              {% for i in range(1, slots+1) %}
                <div class="slot-row" data-slot="{{i}}">
                  <select name="color_{{i}}" class="slot-select">
                    <option value="">--</option>
                    {% for c in palette %}
                      {% set selected = '' %}
                      {% if slot_choices|length >= i and slot_choices[i-1][0] == c %}
                        {% set selected = 'selected' %}
                      {% endif %}
                      <option value="{{c}}" {{selected}}>{{c}}</option>
                    {% endfor %}
                  </select>
                  <input class="weight" type="number" name="weight_{{i}}" min="0" max="1000" step="1" value="{{ slot_choices[i-1][1]|int if slot_choices|length >= i else 0 }}">
                  <button type="button" class="remove small">Remove</button>
                </div>
              {% endfor %}
              </div>

          </section>

          <!-- Randomize controls placed after hotbar -->
          <div class="randomize-controls" style="padding:10px 0;border-top:1px dashed #eee;margin-top:10px">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <button type="button" id="randHotbar" class="small" title="Randomize hotbar (R)">Randomize (R)</button>
              <button type="button" id="randSubset" class="small" title="Randomize subset (S)">Randomize Subset (S)</button>
              <span style="color:#6b7280;font-size:13px">Hotkeys: R/S</span>
            </div>
            <div style="font-size:13px;color:#374151;margin-bottom:6px">Pick subset for Randomize Subset (S):</div>
            <div class="subset-grid">
              {% for c in palette %}
                {% set rgb = palette_map.get(c) %}
                <button type="button" class="subset-color {% if subset_selected and c in subset_selected %}selected{% endif %}" data-color="{{c}}" title="Toggle {{c}}">
                  <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                </button>
              {% endfor %}
            </div>
            <!-- hidden subset input persists selection across submits -->
            <input type="hidden" name="subset" id="subsetInput" value="{{ subset_selected|join(',') if subset_selected else '' }}">
          </div>

          <!-- Grid/Size settings moved to bottom -->
          <div class="grid-settings bottom" style="margin-top:auto;border-top:1px solid #e6e6e6;padding-top:12px">
            <h3 style="font-size:14px;margin:0 0 8px 0;color:#555">Dimensions</h3>
            <label>Width (blocks): <input name="width" value="{{width}}"></label>
            <label>Height (blocks): <input name="height" value="{{height}}"></label>
            <label>Pixels per block: <input name="block_px" value="{{block_px}}"></label>
          </div>
            </section>

        </form>
      </aside>

      <section class="preview-area">
        <div class="output-header">
          <div class="legend">
            <h3 style="margin:0 0 8px 0;font-size:16px;">Unique Colors Used</h3>
            <ul>
              {% for name, w in legend_choices %}
                {% set rgb = palette_map.get(name) %}
                {% if rgb %}
                  <li title="Weight: {{w}}">
                    <span class="swatch" style="background: rgb({{rgb[0]}}, {{rgb[1]}}, {{rgb[2]}})"></span>
                    {{name}}
                    <span style="opacity:0.6;font-size:0.9em">({{w|int}})</span>
                  </li>
                {% else %}
                  <li>{{name}} ({{w|int}})</li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <div class="preview-actions">
            <button type="submit" form="settingsForm" class="generate-primary" title="Generate new pattern">Generate Preview</button>
            <span class="hint" aria-hidden="true">Press Enter</span>
          </div>
        </div>

        <div class="preview">
          <img src="data:image/png;base64,{{img_b64}}" alt="preview">
        </div>
      </section>
    </main>
    <script src="/static/script.js"></script>
  </body>
</html>
